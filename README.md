# mymysqlnd_ms
This is a fork of the mysqlnd replication and load balancing plugin pecl extension (mysqlnd_ms http://php.net/manual/en/book.mysqlnd-ms.php). 

# MAJOR CHANGES
Most changes are in global transaction GTID injection implementation (see: http://php.net/manual/en/mysqlnd-ms.quickstart.gtid.php) and session consistency implementation of the Quality Of Service filter (see: http://php.net/manual/en/mysqlnd-ms.qos-consistency.php).

* PHP7.x porting
* New QOS session consinstency and transaction id injection
* Server side read consistency \(mysql >= 5.7.6 with --session-track-gtids=OWN_GTID\)
  * Mysql native built-in read consistency 
  * PHP session_id read consistency enforcing
* Server side write consistency \(mysql >= 5.7.6 with --session-track-gtids=OWN_GTID\)
  * Multi master write consistency 
  * Multi master write consistency logical partitions
* Client side read consistency
  * Distinct master connection for client side read consistency and gtid injection
  * Client side transaction id injection with memcached mysql plugin
* New config\_dir ini directive for connection based json config files 
* New master\_on ini directive for rw splitting 
* New inject\_on ini directive for transcation id consistency tracking/injection
* New mysqlnd\_ms\_set\_trx\(\) and mysqlnd\_ms\_unset\_trx\(\) php functions for application based transaction tracking

Any suggestions or comments are very welcome.

>**DOCUMENTATION IS NOT READY, I AM WORKING ON IT - FOR CONSISTENCY SEE [SERVICE LEVEL AND CONSISTENCY](docs/BOOK/QUICKSTART-AND-EXAMPLES/SERVICE-LEVEL-AND-CONSISTENCY.md)**



## PHP7.x porting
The mymysqlnd_ms extension has been tested on PHP5.x \(5.5, 5.6\) and PHP7.x \(7.0, 7.1, 7.2\) with no ZTS and ONLY ON LINUX \(centos 6 but i hope it works on any linux distribution\). Requires libxm2 and libmemcached. 

## NEW QOS SESSION CONSISTENCY AND TRANSACTION ID INJECTION
Transaction id injection functionality have been deeply changed in behaviour and configurations directives and it should be used together with QOS filter and session consistency enabled.
As stated 
### New placeholders for global\_transaction\_id\_injection section
In `on_commit`, `fetch_last_gtid`, `check_for_gtid`, `memcached_key`, `memcached_wkey` configuration directives new placeholders can be used:
* `#SID`: Placeholder for the php session\_id value. This is particularly usefull together with the `on_connect` directive  when read consistency through distinct http requests is needed. In the following configuration example the  `"memcached_key": "#SID"` directive instructs the plugin to store the last effective GTID value, generated by the user with session\_id `XXXXXX`, in the memcached key `mymyXXXXXX`. The `"on_connect": 1`, instructs the plugin to read from that memcached key and set it as initial connection value for read consistency enforcing.

```
{
    "myapp": {
        "master": {
            "master_0": {
                "host": "mymaster",
             }
        },
        "slave": {
            "slave_0": {
                "host": "myslave0",
            },
            "slave_1": {
                "host": "myslave1",
            }
        },
        "trx_stickiness": "master",
        "global_transaction_id_injection": {
            "type": 2,
            "on_connect": 1,
            "fetch_last_gtid": "SELECT @@GLOBAL.GTID_EXECUTED AS trx_id FROM DUAL",
            "memcached_host": "mymemcached",
            "memcached_key": "mymy#SID",
            "report_error": true
        },
        "filters": {
            "quality_of_service": {
                "session_consistency": 1
            },
            "random": {
                "sticky": "1"
            }
        },
        "server_charset": "utf8",
        "failover": {
             "strategy": "loop_before_master",
             "remember_failed": true,
             "max_retries": 1
        }
    }
}
```

* `#USER`: Placeholder for the MySQL user. Can be usefull in multi-master write consistency. 
* `#DB`: Placeholder for the MySQL database name. Can be usefull in multi-master write consistency. 


### New configuration directives
* `"type"`: In the global\_transaction\_id\_injection section the `type` configuration directive is mandatory. Value must be an integer between 1-3:
  * Value `1`: Is for [Client side read consistency](README.md#client-side-read-consistency), basically is the old legacy transaction id injection behaviour \(see also the mysqlnd\_ms original documentation [Global transaction IDs](http://php.net/manual/en/mysqlnd-ms.quickstart.gtid.php)\).
  * Value `2`: Is for [Server side read consistency](README.md#server-side-read-consistency).
  * Value `3`: Is for [Server side read consistency](README.md#server-side-read-consistency) with [Client side write consistency](README.md#client-side-write-consistency).


## CONSISTENCY
